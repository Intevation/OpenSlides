<os-head-bar [goBack]="true" [nav]="false">
    <div class="title-slot">
        <h2 *ngIf="poll">{{ 'Motion' | translate }} {{ poll.motion.identifierOrTitle }}</h2>
    </div>

    <div class="menu-slot" *osPerms="'motions.can_manage_polls'">
        <button type="button" mat-icon-button [matMenuTriggerFor]="pollDetailMenu">
            <mat-icon>more_vert</mat-icon>
        </button>
    </div>
</os-head-bar>

<mat-card class="os-card">
    <ng-container [ngTemplateOutlet]="viewTemplate"></ng-container>
</mat-card>

<!-- Detailview for poll -->
<ng-template #viewTemplate>
    <ng-container *ngIf="poll">
        <h1>{{ poll.title }}</h1>
        <span *ngIf="poll.type !== 'analog'">{{ poll.typeVerbose | translate }}</span>

        <div *ngIf="!poll.hasVotes || !poll.stateHasVotes">{{ 'No results to show' | translate }}</div>

        <div *ngIf="poll.stateHasVotes">
            <h2>{{ 'Result' | translate }}</h2>

            <div class="result-wrapper" *ngIf="poll.hasVotes">
                <!-- Chart -->
                <os-charts
                    class="result-chart"
                    *ngIf="chartDataSubject.value"
                    [type]="chartType"
                    [showLegend]="true"
                    [data]="chartDataSubject"
                ></os-charts>

                <!-- result table -->
                <table class="result-table">
                    <tbody>
                        <tr>
                            <th></th>
                            <th translate>Votes</th>
                        </tr>
                        <tr *ngFor="let row of poll.tableData">
                            <td>
                                <os-icon-container *ngIf="row.icon" [icon]="row.icon">
                                    {{ row.key | pollKeyVerbose | translate }}
                                </os-icon-container>
                                <span *ngIf="!row.icon">
                                    {{ row.key | pollKeyVerbose | translate }}
                                </span>
                            </td>
                            <td class="result-cell-definition">
                                {{ row.value | parsePollNumber }}
                                <span *ngIf="row.showPercent">
                                    {{ row.value | pollPercentBase: poll }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Named table: only show if votes are present -->
                <div class="named-result-table" *ngIf="poll.type === 'named'">
                    <h3>{{ 'Single votes' | translate }}</h3>
                    <div *ngIf="votesDataSource.data">
                        <mat-form-field>
                            <input matInput [(ngModel)]="votesDataSource.filter" placeholder="Filter" />
                        </mat-form-field>
                        <mat-table [dataSource]="votesDataSource">
                            <ng-container matColumnDef="key" sticky>
                                <mat-header-cell *matHeaderCellDef>{{ 'Participant' | translate }}</mat-header-cell>
                                <mat-cell *matCellDef="let vote">
                                    <div *ngIf="vote.user">{{ vote.user.getFullName() }}</div>
                                    <div *ngIf="!vote.user">{{ 'Anonymous' | translate }}</div>
                                </mat-cell>
                            </ng-container>
                            <ng-container matColumnDef="value" sticky>
                                <mat-header-cell *matHeaderCellDef>{{ 'Vote' | translate }}</mat-header-cell>
                                <mat-cell *matCellDef="let vote">{{ vote.valueVerbose | translate }}</mat-cell>
                            </ng-container>

                            <mat-header-row *matHeaderRowDef="columnDefinition"></mat-header-row>
                            <mat-row *matRowDef="let vote; columns: columnDefinition"></mat-row>
                        </mat-table>
                    </div>
                    <div *ngIf="!votesDataSource.data">
                        {{ 'The individual votes were made anonymous.' | translate }}
                    </div>
                </div>
            </div>
        </div>

        <div class="poll-content small">
            <div *ngIf="poll.groups && poll.type && poll.type !== 'analog'">
                {{ 'Groups' | translate }}:

                <span *ngFor="let group of poll.groups; let i = index">
                    {{ group.getTitle() | translate }}<span *ngIf="i < poll.groups.length - 1">, </span>
                </span>
            </div>
            <div>{{ '100% base' | translate }}: {{ poll.percentBaseVerbose | translate }}</div>
        </div>
    </ng-container>
</ng-template>

<!-- More Menu -->
<mat-menu #pollDetailMenu="matMenu">
    <os-projector-button [menuItem]="true" [object]="poll" *osPerms="'core.can_manage_projector'"></os-projector-button>
    <button *osPerms="'motions.can_manage_polls'" mat-menu-item (click)="openDialog()">
        <mat-icon>edit</mat-icon>
        <span translate>Edit</span>
    </button>
    <button
        mat-menu-item
        *osPerms="'motions.can_manage_polls'; and: poll && poll.type === 'named'"
        (click)="pseudoanonymizePoll()"
    >
        <mat-icon>warning</mat-icon>
        <span translate>Anonymize votes</span>
    </button>
    <mat-divider></mat-divider>
    <button *osPerms="'motions.can_manage_polls'" mat-menu-item (click)="deletePoll()">
        <mat-icon color="warn">delete</mat-icon>
        <span translate>Delete</span>
    </button>
</mat-menu>
